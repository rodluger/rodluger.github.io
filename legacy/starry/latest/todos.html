

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>todos &mdash; starry latest documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
        <script src="_static/js/hacks.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Coverage reports" href="coverage.html" />
    <link rel="prev" title="Developer" href="developer.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> starry
          

          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html"> Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html"> New in version 1.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html"> Examples &amp; tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html"> API</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html"> Extensions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developer.html"> Developer</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">ToDo list</a></li>
<li class="toctree-l2"><a class="reference external" href="https://dev.azure.com/rodluger/starry/_build">Azure pipelines page</a></li>
<li class="toctree-l2"><a class="reference internal" href="coverage.html">Coverage reports</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/rodluger/starry"> Github</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/rodluger/starry/issues"> Submit an issue</a></li>
<li class="toctree-l1"><a class="reference external" href="https://ui.adsabs.harvard.edu/public-libraries/b0KqtPtYRj6I7T8eAZc5Ig"> Papers</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">starry</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="developer.html">Developer</a> &raquo;</li>
        
      <li>todos</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="todos">
<h1>todos<a class="headerlink" href="#todos" title="Permalink to this headline">Â¶</a></h1>
<p>There are <strong>33</strong> todo items that need to be addressed in <code class="docutils literal notranslate"><span class="pre">starry</span></code>.</p>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/kepler.py#L1181">kepler.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>        .. note::
            Users may call the :py:meth:`draw` method of this class to draw
            from the posterior after calling :py:meth:`solve`.
        &quot;&quot;&quot;
<span class="hll">        # TODO: Implement for spectral maps?
</span>        self._no_spectral()

        # Check that the data is set
        if self._flux is None or self._C is None:
            raise ValueError(&quot;Please provide a dataset with `set_data()`.&quot;)

        # Get the full design matrix
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/kepler.py#L1343">kepler.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">Returns</span><span class="p">:</span>
            <span class="n">lnlike</span><span class="p">:</span> <span class="n">The</span> <span class="n">log</span> <span class="n">marginal</span> <span class="n">likelihood</span><span class="o">.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # TODO: Implement for spectral maps?</span>
<span class="hll"><span class="s2">        self._no_spectral()</span>
</span>
<span class="s2">        # Check that the data is set</span>
<span class="s2">        if self._flux is None or self._C is None:</span>
<span class="s2">            raise ValueError(&quot;Please provide a dataset with `set_data()`.&quot;)</span>

<span class="s2">        # Get the full design matrix</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/maps.py#L1808">maps.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>            <span class="c1"># Require at least one point to be at a different latitude</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">lat</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="c1"># TODO: untested!</span>
<span class="hll">                <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
</span>                <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>

            <span class="c1"># Construct the design matrix that gives us</span>
            <span class="c1"># the coefficients of the polynomial fit</span>
            <span class="c1"># centered on the current point</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/maps.py#L2699">maps.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">source_npts</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">lazy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lazy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">lazy</span>

<span class="hll">    <span class="c1"># TODO: phase this next warning out</span>
</span>    <span class="k">if</span> <span class="n">source_npts</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Finite source size is still an experimental feature. &quot;</span>
            <span class="s2">&quot;Use it with care.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Limb-darkened?</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/maps.py#L2709">maps.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="c1"># Limb-darkened?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ydeg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rv</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">reflected</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>

        <span class="c1"># TODO: Add support for wavelength-dependent limb darkening</span>
<span class="hll">        <span class="k">if</span> <span class="n">nw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Multi-wavelength limb-darkened maps are not yet supported.&quot;</span>
            <span class="p">)</span>

        <span class="n">Bases</span> <span class="o">=</span> <span class="p">(</span><span class="n">LimbDarkenedBase</span><span class="p">,</span> <span class="n">MapBase</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/core.py#L92">core.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="bp">self</span><span class="o">.</span><span class="n">_tensordotDz</span> <span class="o">=</span> <span class="n">tensordotDzOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_ops</span><span class="o">.</span><span class="n">tensordotDz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dotR</span> <span class="o">=</span> <span class="n">dotROp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_ops</span><span class="o">.</span><span class="n">dotR</span><span class="p">)</span>

        <span class="c1"># Filter</span>
<span class="hll">        <span class="c1"># TODO: Make the filter operator sparse</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_F</span> <span class="o">=</span> <span class="n">FOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_ops</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_ops</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_ops</span><span class="o">.</span><span class="n">Ny</span><span class="p">)</span>

        <span class="c1"># Misc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spotYlm</span> <span class="o">=</span> <span class="n">spotYlmOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_ops</span><span class="o">.</span><span class="n">spotYlm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydeg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pT</span> <span class="o">=</span> <span class="n">pTOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c_ops</span><span class="o">.</span><span class="n">pT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reflected</span><span class="p">:</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/core.py#L112">core.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>                <span class="bp">self</span><span class="o">.</span><span class="n">_minimize</span> <span class="o">=</span> <span class="n">minimizeOp</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydeg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">udeg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdeg</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
<span class="hll">            <span class="c1"># TODO: Implement minimization for spectral maps?</span>
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_minimize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LimbDarkIsPhysical</span> <span class="o">=</span> <span class="n">LDPhysicalOp</span><span class="p">(</span><span class="n">_c_ops</span><span class="o">.</span><span class="n">nroots</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rT</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/core.py#L515">core.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydeg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">M</span>

        <span class="c1"># Rotate to the sky frame</span>
<span class="hll">        <span class="c1"># TODO: Do this in a single compound rotation</span>
</span>        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dotR</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dotR</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dotR</span><span class="p">(</span>
                    <span class="n">M</span><span class="p">,</span>
                    <span class="o">-</span><span class="n">tt</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">obl</span><span class="p">),</span>
                    <span class="o">-</span><span class="n">tt</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">obl</span><span class="p">),</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/core.py#L618">core.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Rotate to the sky frame</span>
<span class="hll">        <span class="c1"># TODO: Do this in a single compound rotation</span>
</span>        <span class="n">MT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dotR</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dotR</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dotR</span><span class="p">(</span>
                    <span class="n">MT</span><span class="p">,</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/core.py#L2117">core.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">sec_veq</span><span class="p">,</span>
        <span class="n">keplerian</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the observed system radial velocity (RV maps only).&quot;&quot;&quot;</span>
<span class="hll">        <span class="c1"># TODO: This method is currently very inefficient, as it</span>
</span>        <span class="c1"># calls `X` twice per call and instantiates an `orbit`</span>
        <span class="c1"># instance up to three separate times per call. We should</span>
        <span class="c1"># re-code the logic from `X()` in here to optimize it.</span>

        <span class="c1"># Compute the RV filter</span>
        <span class="n">pri_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">compute_rv_filter</span><span class="p">(</span>
            <span class="n">pri_inc</span><span class="p">,</span> <span class="n">pri_obl</span><span class="p">,</span> <span class="n">pri_veq</span><span class="p">,</span> <span class="n">pri_alpha</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/math.py#L232">math.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>            <span class="n">MAP</span> <span class="n">solution</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">Cholesky</span> <span class="n">factorization</span> <span class="n">of</span> <span class="n">the</span> <span class="n">corresponding</span>
            <span class="n">covariance</span> <span class="n">matrix</span><span class="o">.</span>

        <span class="s2">&quot;&quot;&quot;</span>
<span class="hll"><span class="s2">        # TODO: These if statements won&#39;t play well with @autocompile!!!</span>
</span>
<span class="s2">        # Compute C^-1 . X</span>
<span class="s2">        if cho_C.ndim == 0:</span>
<span class="s2">            CInvX = X / cho_C ** 2</span>
<span class="s2">        elif cho_C.ndim == 1:</span>
<span class="s2">            CInvX = tt.dot(tt.diag(1 / cho_C ** 2), X)</span>
<span class="s2">        else:</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/math.py#L287">math.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>            all possible spherical harmonic vectors, which is analytically
            computable for the linear `starry` model.

        &quot;&quot;&quot;
<span class="hll">        # TODO: These if statements won&#39;t play well with @autocompile!!!
</span>
        # Compute the GP mean
        gp_mu = tt.dot(X, mu)

        # Compute the GP covariance
        if L.ndim == 0:
            XLX = tt.dot(X, tt.transpose(X)) * L
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/math.py#L340">math.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>            all possible spherical harmonic vectors, which is analytically
            computable for the linear `starry` model.

        &quot;&quot;&quot;
<span class="hll">        # TODO: These if statements won&#39;t play well with @autocompile!!!
</span>
        # Compute the GP mean
        gp_mu = tt.dot(X, mu)

        # Residual vector
        r = tt.reshape(flux - gp_mu, (-1, 1))
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/utils.py#L57">utils.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>        - an integer (`int`, `np.int`, `np.int16`, `np.int32`, `np.int64`)
        - a numpy boolean (`np.array(True)`, `np.array(False)`)
        - a numpy float array with ndim equal to 0, 1, 2, or 3

<span class="hll">    # TODO: Cast lists to arrays and floats to np.array(float)
</span>
    &quot;&quot;&quot;
    ttype = type(arg)
    if is_theano(arg):
        return ttype
    else:
        if ttype in integers:
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/polybasis.py#L69">polybasis.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">bpT</span> <span class="o">=</span> <span class="n">inputs</span>

        <span class="c1"># TODO: When any of the coords are zero, there&#39;s a div</span>
<span class="hll">        <span class="c1"># by zero below. This hack fixes the issue. We should</span>
</span>        <span class="c1"># think of a better way of doing this!</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-8</span>
        <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="n">z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="n">tol</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/basis.h#L48">basis.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">Compute the `P(z)` part of the Ylm vectors.</span>

<span class="cm">TODO: This can be sped up with sparse algebra.</span>
<span class="hll">
</span><span class="cm">*/</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Scalar</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">legendre</span><span class="p">(</span><span class="kt">int</span> <span class="n">lmax</span><span class="p">,</span>
                     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Triplet</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="o">&gt;&gt;&gt;</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Compute densely</span>
  <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/basis.h#L582">basis.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">explicit</span> <span class="nf">Basis</span><span class="p">(</span><span class="kt">int</span> <span class="n">ydeg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">udeg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fdeg</span><span class="p">,</span> <span class="n">T</span> <span class="n">norm</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">root_pi</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">())</span>
      <span class="o">:</span> <span class="n">ydeg</span><span class="p">(</span><span class="n">ydeg</span><span class="p">),</span> <span class="n">udeg</span><span class="p">(</span><span class="n">udeg</span><span class="p">),</span> <span class="n">fdeg</span><span class="p">(</span><span class="n">fdeg</span><span class="p">),</span> <span class="n">deg</span><span class="p">(</span><span class="n">ydeg</span> <span class="o">+</span> <span class="n">udeg</span> <span class="o">+</span> <span class="n">fdeg</span><span class="p">),</span> <span class="n">norm</span><span class="p">(</span><span class="n">norm</span><span class="p">),</span>
        <span class="n">x_cache</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">y_cache</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">z_cache</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">deg_cache</span><span class="p">(</span><span class="mi">-1</span><span class="p">)</span> <span class="p">{</span>

<span class="hll">    <span class="c1">// TODO: This class needs to be re-written. We&#39;re computing the same</span>
</span>    <span class="c1">// things over and over again just to get different shapes...</span>

    <span class="c1">// Compute the augmented matrices</span>
    <span class="n">Eigen</span><span class="o">::</span><span class="n">SparseMatrix</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">A1Inv_</span><span class="p">,</span> <span class="n">A2_</span><span class="p">,</span> <span class="n">A_</span><span class="p">,</span> <span class="n">U1_</span><span class="p">;</span>
    <span class="n">RowVector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">rT_</span><span class="p">,</span> <span class="n">rTA1_</span><span class="p">;</span>
    <span class="n">computeA1</span><span class="p">(</span><span class="n">deg</span><span class="p">,</span> <span class="n">A1_big</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span>
    <span class="n">computeA1Inv</span><span class="p">(</span><span class="n">deg</span><span class="p">,</span> <span class="n">A1_big</span><span class="p">,</span> <span class="n">A1Inv_</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/filter.h#L250">filter.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="o">&gt;</span> <span class="n">pf</span><span class="p">;</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">A1_f</span> <span class="o">*</span> <span class="n">f</span><span class="p">;</span>

    <span class="c1">// Multiply them</span>
<span class="hll">    <span class="c1">// TODO: DpDpf and DpDpu are sparse, and we should probably exploit that</span>
</span>    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">udeg</span> <span class="o">&gt;</span> <span class="n">fdeg</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">computePolynomialProduct</span><span class="p">(</span><span class="n">udeg</span><span class="p">,</span> <span class="n">pu</span><span class="p">,</span> <span class="n">fdeg</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="n">DpDpu</span><span class="p">,</span> <span class="n">DpDpf</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">computePolynomialProduct</span><span class="p">(</span><span class="n">fdeg</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="n">udeg</span><span class="p">,</span> <span class="n">pu</span><span class="p">,</span> <span class="n">DpDpf</span><span class="p">,</span> <span class="n">DpDpu</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/limbdark.h#L5">limbdark.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>\file limbdark.h
\brief Limb darkening utilities from Agol, Luger &amp; Foreman-Mackey (2019).

<span class="hll">TODO: Loop downward in `v` until `J[v] != 0`
</span>TODO: Test all special cases

*/

#ifndef _STARRY_LIMBDARK_H_
#define _STARRY_LIMBDARK_H_
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/limbdark.h#L6">limbdark.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>\file limbdark.h
\brief Limb darkening utilities from Agol, Luger &amp; Foreman-Mackey (2019).

TODO: Loop downward in `v` until `J[v] != 0`
<span class="hll">TODO: Test all special cases
</span>
*/

#ifndef _STARRY_LIMBDARK_H_
#define _STARRY_LIMBDARK_H_

#include &quot;ellip.h&quot;
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/misc.h#L99">misc.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>                    <span class="n">RowVector</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">bamp</span><span class="p">,</span> <span class="n">Scalar</span> <span class="o">&amp;</span><span class="n">bsigma</span><span class="p">,</span> <span class="n">Scalar</span> <span class="o">&amp;</span><span class="n">blat</span><span class="p">,</span>
                    <span class="n">Scalar</span> <span class="o">&amp;</span><span class="n">blon</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Forward diff for sigma</span>
<span class="hll">  <span class="c1">// TODO: Compute the backprop expression</span>
</span>  <span class="k">using</span> <span class="n">ADType</span> <span class="o">=</span> <span class="n">ADScalar</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">ADType</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_</span><span class="p">;</span>
  <span class="n">sigma</span><span class="p">.</span><span class="n">derivatives</span><span class="p">()</span> <span class="o">=</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="o">&gt;::</span><span class="n">Unit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="c1">// Compute the integrals recursively</span>
  <span class="n">Vector</span><span class="o">&lt;</span><span class="n">ADType</span><span class="o">&gt;</span> <span class="n">IP</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">Vector</span><span class="o">&lt;</span><span class="n">ADType</span><span class="o">&gt;</span> <span class="n">ID</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/wigner.h#L417">wigner.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>          <span class="n">tol_ad</span><span class="p">,</span> <span class="n">D_ad</span><span class="p">,</span> <span class="n">R_ad</span><span class="p">);</span>

    <span class="c1">// Extract the matrices and their derivatives</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">ydeg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">      <span class="c1">// TODO: This data copy is *very* slow; is there a better way?</span>
</span>      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">R</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">R_ad</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">).</span><span class="n">value</span><span class="p">();</span>
          <span class="n">DRDx</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">R_ad</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">).</span><span class="n">derivatives</span><span class="p">()(</span><span class="mi">0</span><span class="p">);</span>
          <span class="n">DRDy</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">R_ad</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">).</span><span class="n">derivatives</span><span class="p">()(</span><span class="mi">1</span><span class="p">);</span>
          <span class="n">DRDz</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">R_ad</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">).</span><span class="n">derivatives</span><span class="p">()(</span><span class="mi">2</span><span class="p">);</span>
          <span class="n">DRDtheta</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">R_ad</span><span class="p">[</span><span class="n">l</span><span class="p">](</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">).</span><span class="n">derivatives</span><span class="p">()(</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/wigner.h#L531">wigner.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">npts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Dot them in</span>
<span class="hll">    <span class="c1">// TODO: There must be a more efficient way of doing this.</span>
</span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">ydeg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// d / dargs</span>
      <span class="n">dotR_bx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">*</span> <span class="n">l</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">DRDx</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                     <span class="p">.</span><span class="n">cwiseProduct</span><span class="p">(</span><span class="n">bMR</span><span class="p">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">*</span> <span class="n">l</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                     <span class="p">.</span><span class="n">sum</span><span class="p">();</span>
      <span class="n">dotR_by</span> <span class="o">+=</span> <span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">*</span> <span class="n">l</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">DRDy</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                     <span class="p">.</span><span class="n">cwiseProduct</span><span class="p">(</span><span class="n">bMR</span><span class="p">.</span><span class="n">block</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">*</span> <span class="n">l</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/reflected/geometry.h#L759">geometry.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">xi</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">lam</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="c1">// We need to do this case-by-case</span>
<span class="hll">    <span class="c1">// TODO: This section is really messy / cumbersome. Clean it up.</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">((</span><span class="mi">-1</span> <span class="o">-</span> <span class="n">xo</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">-1</span> <span class="o">-</span> <span class="n">xo</span><span class="p">)</span> <span class="o">+</span> <span class="n">yo</span> <span class="o">*</span> <span class="n">yo</span> <span class="o">&lt;</span> <span class="n">ro</span> <span class="o">*</span> <span class="n">ro</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/reflected/primitive.h#L137">primitive.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">    Compute the helper integral I by upward and/or downward recursion.</span>

<span class="cm">    TODO: This code currently can&#39;t handle cases where the (lo, hi)</span>
<span class="hll"><span class="cm">          limit pairs in the kappa vector belong to different regimes.</span>
</span><span class="cm">          These regimes are</span>

<span class="cm">                sin(kappa / 2) &gt; 0.5 --&gt; upward recursion</span>
<span class="cm">                sin(kappa / 2) &lt;= 0.5 --&gt; downward recursion</span>

<span class="cm">          Cases where the two angles are close to 0.5 are *fine*. Issues</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/reflected/primitive.h#L234">primitive.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kr">inline</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">W_indef</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">nmax</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">s2_</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">q2</span><span class="p">,</span>
                         <span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">q3</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">(</span><span class="n">nmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

<span class="hll">  <span class="c1">// TODO: Is this instability encountered in practice?</span>
</span>  <span class="c1">// If so, find the limiting value of W when s2 = 0.</span>
  <span class="n">T</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s2_</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">STARRY_MIN_SIN_ALPHA</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">s2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">T</span><span class="p">(</span><span class="n">STARRY_MIN_SIN_ALPHA</span><span class="p">)</span> <span class="o">:</span> <span class="n">T</span><span class="p">(</span><span class="o">-</span><span class="n">STARRY_MIN_SIN_ALPHA</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/reflected/primitive.h#L358">primitive.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-=</span> <span class="n">b</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">f0</span><span class="p">;</span>
  <span class="n">c</span><span class="p">(</span><span class="n">nmax</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-=</span> <span class="n">fN</span><span class="p">;</span>

  <span class="c1">// Construct the tridiagonal matrix</span>
<span class="hll">  <span class="c1">// TODO: We should probably use a sparse solve here!</span>
</span>  <span class="n">Matrix</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">A</span><span class="p">(</span><span class="n">nmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">A</span><span class="p">.</span><span class="n">setZero</span><span class="p">();</span>
  <span class="n">A</span><span class="p">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
  <span class="n">A</span><span class="p">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">-1</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">segment</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">A</span><span class="p">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">setOnes</span><span class="p">();</span>

  <span class="c1">// Solve</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/reflected/primitive.h#L572">primitive.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">sgn</span> <span class="o">*=</span> <span class="mi">-1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Special limit: sin(theta) = 0</span>
<span class="hll">  <span class="c1">// TODO: eliminate the calls to pow in favor of recursion</span>
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">STARRY_T_TOL</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">sgnct</span> <span class="o">=</span> <span class="n">ct</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">ct</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">-1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">ydeg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="o">-</span><span class="n">l</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">l</span> <span class="o">-</span> <span class="n">m</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/starry/_core/ops/lib/include/reflected/primitive.h#L604">primitive.h</a>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="p">}</span>

  <span class="c1">// Special limit: cos(theta) = 0</span>
  <span class="c1">// TODO: eliminate the calls to pow in favor of recursion</span>
<span class="hll">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">STARRY_T_TOL</span><span class="p">)</span> <span class="p">{</span>
</span>
    <span class="kt">int</span> <span class="n">sgnst</span> <span class="o">=</span> <span class="n">st</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">st</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">-1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">ydeg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="o">-</span><span class="n">l</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">l</span> <span class="o">-</span> <span class="n">m</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/tests/greedy/test_exceptions_greedy.py#L36">test_exceptions_greedy.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="c1"># Bad `m`</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">map</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c1"># TODO: It would be nice if `map[1, 3] = ...` raised</span>
<span class="hll">    <span class="c1"># an error, but currently it does nothing (silently).</span>
</span>
    <span class="c1"># Bad type</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">map</span><span class="p">[</span><span class="mf">2.3</span><span class="p">,</span> <span class="mf">5.7</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">map</span><span class="p">[</span><span class="mf">2.3</span><span class="p">,</span> <span class="mf">5.7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/tests/greedy/test_light_delay_greedy.py#L13">test_light_delay_greedy.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">sec</span> <span class="o">=</span> <span class="n">starry</span><span class="o">.</span><span class="n">Secondary</span><span class="p">(</span><span class="n">starry</span><span class="o">.</span><span class="n">Map</span><span class="p">(),</span> <span class="n">porb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">sys</span> <span class="o">=</span> <span class="n">starry</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">light_delay</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">light_delay</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="hll">    <span class="c1"># TODO: Add tests here.</span>
</span></pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/tests/greedy/test_system_greedy.py#L87">test_system_greedy.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">sys</span> <span class="o">=</span> <span class="n">starry</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="n">sec</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">50</span><span class="p">)))</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">flux</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="hll">    <span class="c1"># TODO: Add an analytic validation here</span>
</span></pre></div>
</td></tr></table></div>
<p><a class="reference external" href="https://github.com/rodluger/starry/blob/fac89fadb83a8e02b676e345d66882b1b7268534/tests/lazy/test_op_gradients.py#L219">test_op_gradients.py</a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="p">)</span>


<span class="s2">&quot;&quot;&quot;</span>
<span class="hll"><span class="s2"># TODO: Implement the gradient of the OrenNayarOp.</span>
</span><span class="s2">def test_intensity_reflected(abs_tol=1e-5, rel_tol=1e-5, eps=1e-7):</span>
<span class="s2">    with change_flags(compute_test_value=&quot;off&quot;):</span>
<span class="s2">        map = starry.Map(ydeg=2, udeg=2, reflected=True)</span>
<span class="s2">        np.random.seed(11)</span>
<span class="s2">        lat = 180 * (np.random.random(10) - 0.5)</span>
<span class="s2">        lon = 360 * (np.random.random(10) - 0.5)</span>
<span class="s2">        y = [1.0] + list(np.random.randn(8))</span>
</pre></div>
</td></tr></table></div>
</div>


           </div>
           
          </div>
          <footer>
  
  <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
    
    <a href="coverage.html" class="btn btn-neutral float-right" title="Coverage reports" accesskey="n"
      rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
    
    
    <a href="developer.html" class="btn btn-neutral float-left" title="Developer" accesskey="p"
      rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
    
  </div>
  

  <hr />

  <div role="contentinfo">
    <p>
      
      &copy; Copyright 2019, Rodrigo Luger.
      <span class="lastupdated">
        Last updated on 2021 Feb 17 at 20:03:29 UTC.
      </span>

    </p>
  </div>
  
  
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a
    href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by
  <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>